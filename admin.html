<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin — Éclaïr</title>
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>

  <!-- Gate: hide protected UI until authenticated as allowed admin -->
  <style>
    .admin-gate { display: none; }
    body.admin-auth .admin-gate { display: block; }
    body.admin-auth #authBox { display: none !important; }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <div class="logo">
      <a href="index.html" aria-label="Éclaïr Home"><img src="logo.jpg" alt="Éclaïr logo"></a>
    </div>
    <button class="menu-toggle" aria-label="Toggle Menu" aria-expanded="false">&#9776;</button>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="menu.html">Menu</a></li>
      <li><a class="active" href="admin.html">Admin</a></li>
    </ul>
  </nav>

  <!-- Hamburger + UI helpers -->
  <script src="script.js" defer></script>

  <main style="padding:20px; padding-top:80px; max-width:1100px; margin:0 auto;">

    <!-- AUTH (visible when logged out / not allowed) -->
    <div class="card" id="authBox">
      <h1>Admin — Éclaïr</h1>
      <h2>Sign in</h2>
      <div class="row">
        <input type="email" id="email" placeholder="Admin email" autocomplete="username"/>
        <input type="password" id="password" placeholder="Passcode" autocomplete="current-password"/>
      </div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnLogin">Sign in</button>
      </div>
    </div>

    <!-- DASHBOARD (only when allowed admin) -->
    <div id="dash" class="admin-gate">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">Products</h2>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="filterCategory">
              <option value="">All categories</option>
              <option>Pastries</option><option>Cakes</option><option>Drinks</option>
              <option>Sparkling</option><option>Iced Tea</option><option>Tea</option>
              <option>Coffee</option><option>Iced Coffee</option>
            </select>
            <button class="btn muted" id="btnSignOut">Sign out</button>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 id="formTitle">Add / Edit product</h3>

          <div class="row-3">
            <input id="pName" placeholder="Name"/>
            <input id="pBasePrice" type="number" placeholder="Base Price (Rs)"/>
            <select id="pCategory">
              <option>Pastries</option><option>Cakes</option><option>Drinks</option>
              <option>Sparkling</option><option>Iced Tea</option><option>Tea</option>
              <option>Coffee</option><option>Iced Coffee</option>
            </select>
          </div>

          <div class="row" style="margin-top:10px;">
            <input id="pImageUrl" placeholder="Image URL (or upload below)"/>
            <label class="pill"><input type="checkbox" id="pVisible" checked/> Visible</label>
          </div>

          <div class="row" style="margin-top:10px;">
            <input type="file" id="pImageFile" accept="image/*"/>
            <img id="pPreview" class="preview" alt="">
          </div>

          <div class="section">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h4 style="margin:0;">Sizes (optional)</h4>
              <button class="btn small" type="button" id="btnAddSize">+ Add size</button>
            </div>
            <div class="list" id="sizesList"></div>
            <p class="muted" style="margin:6px 0 0;">If defined, selected size price overrides base price.</p>
          </div>

          <div class="section">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h4 style="margin:0;">Flavours (optional)</h4>
              <button class="btn small" type="button" id="btnAddFlavour">+ Add flavour</button>
            </div>
            <div class="list" id="flavoursList"></div>
          </div>

          <div class="section">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h4 style="margin:0;">Toppings (optional)</h4>
              <button class="btn small" type="button" id="btnAddTopping">+ Add topping</button>
            </div>
            <div class="list" id="toppingsList"></div>
            <p class="muted" style="margin:6px 0 0;">Toppings add to the price.</p>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" id="btnSave">Save</button>
            <button class="btn muted hide" id="btnCancelEdit">Cancel edit</button>
          </div>
        </div>

        <div class="card">
          <h3>Tips</h3>
          <p class="muted">Use Sizes for S/M/L pricing. Flavours for taste-only choice. Toppings add price.</p>
        </div>
      </div>

      <div class="card">
        <table>
          <thead><tr><th>Item</th><th>Category</th><th>Price</th><th>Visible</th><th class="right">Actions</th></tr></thead>
          <tbody id="tbodyProducts"></tbody>
        </table>
      </div>
    </div>
  </main>

<script>
// ===== Firebase init =====
const firebaseConfig = {
  apiKey: "AIzaSyDnYlw01KhjWRXLhatnr9fFcXA4Q_zOs10",
  authDomain: "eclair-501b7.firebaseapp.com",
  databaseURL: "https://eclair-501b7-default-rtdb.firebaseio.com",
  projectId: "eclair-501b7",
  storageBucket: "eclair-501b7.appspot.com",
  messagingSenderId: "1042027942352",
  appId: "1:1042027942352:web:fa760d5609f5713c0d69d5",
  measurementId: "G-BC1Z5MKSTH"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

// ===== ALLOWED ADMIN UIDs (only these two) =====
const ALLOWED_UIDS = new Set([
  'RhMAQ5ey7zYdRLwtr5fxjqVrfgN2',
  'uufregjJNyXeLfjZ9bb0Aj8kzSh1'
]);

// ===== Cloudinary upload (unsigned) =====
const CLOUDINARY_CLOUD = "dicwpp1ux";
const CLOUDINARY_UNSIGNED_PRESET = "uufregjJNyXeLfjZ9bb0Aj8kzSh1";
async function uploadToCloudinary(file) {
  if (!file) return "";
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/upload`;
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", CLOUDINARY_UNSIGNED_PRESET);
  const res = await fetch(url, { method: "POST", body: form });
  if (!res.ok) throw new Error("Cloudinary upload failed");
  const data = await res.json();
  return data.secure_url || data.url;
}

// ===== DOM refs =====
const pName = document.getElementById('pName');
const pBasePrice = document.getElementById('pBasePrice');
const pCategory = document.getElementById('pCategory');
const pImageUrl = document.getElementById('pImageUrl');
const pImageFile = document.getElementById('pImageFile');
const pPreview = document.getElementById('pPreview');
const pVisible = document.getElementById('pVisible');
const btnSave = document.getElementById('btnSave');
const btnCancelEdit = document.getElementById('btnCancelEdit');
const filterCategory = document.getElementById('filterCategory');
const tbodyProducts = document.getElementById('tbodyProducts');
const formTitle = document.getElementById('formTitle');

const email = document.getElementById('email');
const password = document.getElementById('password');
const btnLogin = document.getElementById('btnLogin');
const btnSignOut = document.getElementById('btnSignOut');

let editingKey = null;
let productsRef = null;
let productsHandler = null;

// ===== Dynamic list helpers =====
const sizesList = document.getElementById('sizesList');
const flavoursList = document.getElementById('flavoursList');
const toppingsList = document.getElementById('toppingsList');

document.getElementById('btnAddSize').onclick = () => addSizeRow();
document.getElementById('btnAddFlavour').onclick = () => addFlavourRow();
document.getElementById('btnAddTopping').onclick = () => addToppingRow();

function addSizeRow(size = {label:'', price:''}) {
  const row = document.createElement('div');
  row.className = 'row-line';
  row.innerHTML = `
    <input placeholder="Size label (e.g., Small)" value="${size.label||''}">
    <input type="number" placeholder="Price (Rs)" value="${size.price||''}">
    <button class="btn danger small" type="button">✕</button>
  `;
  row.querySelector('button').onclick = () => row.remove();
  sizesList.appendChild(row);
}
function addFlavourRow(flavour = {label:''}) {
  const row = document.createElement('div');
  row.className = 'row-line flavour';
  row.innerHTML = `
    <input placeholder="Flavour label (e.g., Vanilla)" value="${flavour.label||''}">
    <button class="btn danger small" type="button">✕</button>
  `;
  row.querySelector('button').onclick = () => row.remove();
  flavoursList.appendChild(row);
}
function addToppingRow(topping = {label:'', price:''}) {
  const row = document.createElement('div');
  row.className = 'row-line';
  row.innerHTML = `
    <input placeholder="Topping label (e.g., Whipped cream)" value="${topping.label||''}">
    <input type="number" placeholder="Price (Rs)" value="${topping.price||''}">
    <button class="btn danger small" type="button">✕</button>
  `;
  row.querySelector('button').onclick = () => row.remove();
  toppingsList.appendChild(row);
}

function setListsUI(p){
  sizesList.innerHTML = ''; (p.sizes||[]).forEach(addSizeRow);
  flavoursList.innerHTML = ''; (p.flavours||[]).forEach(addFlavourRow);
  toppingsList.innerHTML = ''; (p.toppings||[]).forEach(addToppingRow);
}
function clearForm() {
  editingKey = null; formTitle.textContent = 'Add / Edit product';
  pName.value = ''; pBasePrice.value = ''; pCategory.value = 'Pastries';
  pImageUrl.value = ''; pImageFile.value = ''; pPreview.src = '';
  pVisible.checked = true; sizesList.innerHTML = ''; flavoursList.innerHTML = ''; toppingsList.innerHTML = '';
  btnCancelEdit.classList.add('hide');
}

// ===== Table render =====
function renderRow(key, p) {
  const priceText = (p.sizes && p.sizes.length)
    ? ('Sizes: ' + p.sizes.map(s=>`${s.label} Rs ${s.price}`).join(', '))
    : ('Base Rs ' + Number(p.basePrice||0));
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <div style="display:flex; gap:10px; align-items:flex-start;">
        <img src="${p.image || ''}" class="preview" alt="">
        <div>
          <div style="font-weight:700">${p.name || ''}</div>
          <div class="muted" style="max-width:420px;word-break:break-all;">${p.image || 'No image'}</div>
          <div class="muted">Flavours: ${(p.flavours||[]).map(f=>f.label).join(', ') || '—'}</div>
          <div class="muted">Toppings: ${(p.toppings||[]).map(t=>`${t.label} (Rs ${t.price})`).join(', ') || '—'}</div>
        </div>
      </div>
    </td>
    <td><span class="pill">${p.category || '-'}</span></td>
    <td>${priceText}</td>
    <td>${p.visible ? 'Yes' : 'No'}</td>
    <td class="right">
      <button class="btn muted" data-edit="${key}">Edit</button>
      <button class="btn danger" data-del="${key}">Delete</button>
    </td>
  `;
  tr.querySelector(`[data-edit="${key}"]`).onclick = () => {
    editingKey = key; formTitle.textContent = 'Edit product';
    pName.value = p.name || ''; pBasePrice.value = Number(p.basePrice || 0);
    pCategory.value = p.category || 'Pastries'; pImageUrl.value = p.image || ''; pPreview.src = p.image || '';
    pVisible.checked = !!p.visible; setListsUI(p); btnCancelEdit.classList.remove('hide');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  tr.querySelector(`[data-del="${key}"]`).onclick = async () => {
    if (!confirm('Delete this product?')) return;
    await db.ref(`products/${key}`).remove();
  };
  return tr;
}

function wipeTable() { tbodyProducts.innerHTML = ''; }
function wipeAllUI() {
  clearForm(); wipeTable();
  filterCategory.value = '';
  pImageFile.value = ''; pPreview.src = '';
}

// ===== Attach / Detach Realtime listener (only when allowed admin) =====
function attachProductsListener() {
  detachProductsListener();
  productsRef = db.ref('products').orderByChild('createdAt');
  productsHandler = productsRef.on('value', snap => {
    wipeTable();
    const obj = snap.val() || {};
    const cat = filterCategory.value;
    const entries = Object.entries(obj).sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
    for (const [key, p] of entries) {
      if (cat && p.category !== cat) continue;
      tbodyProducts.appendChild(renderRow(key, p));
    }
  });
}
function detachProductsListener() {
  if (productsRef && productsHandler) productsRef.off('value', productsHandler);
  else if (productsRef) productsRef.off();
  productsRef = null; productsHandler = null;
}

// ===== Auth Gate (UID allowlist) =====
function lockDownUI() {
  document.body.classList.remove('admin-auth');
  detachProductsListener();
  wipeAllUI();
}

async function unlockIfAllowed(user) {
  if (!ALLOWED_UIDS.has(user.uid)) {
    await auth.signOut();
    alert('You have no right to access it.');
    return;
  }
  document.body.classList.add('admin-auth');
  attachProductsListener();
}

auth.onAuthStateChanged(async (user) => {
  if (user) { await unlockIfAllowed(user); }
  else { lockDownUI(); }
});

// ===== Actions =====
btnLogin.onclick = async () => {
  const em = (email.value || '').trim();
  const pw = (password.value || '');
  if (!em || !pw) { alert('You have no right to access it.'); return; }
  try {
    await auth.signInWithEmailAndPassword(em, pw);
    // onAuthStateChanged will perform UID allowlist check
  } catch (e) {
    alert('You have no right to access it.');
  }
};
btnSignOut.onclick = () => auth.signOut();

// ===== Image preview & filters =====
pImageFile.onchange = () => {
  const file = pImageFile.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => pPreview.src = e.target.result;
  reader.readAsDataURL(file);
};
filterCategory.onchange = () => attachProductsListener();

// ===== Save product (rules still enforce server-side) =====
btnSave.onclick = async () => {
  try {
    const name = pName.value.trim();
    const basePrice = Number(pBasePrice.value || 0);
    const category = pCategory.value;
    const visible = pVisible.checked;
    if (!name) return alert('Name is required');

    let image = pImageUrl.value.trim();
    const file = pImageFile.files?.[0];
    if (file) image = await uploadToCloudinary(file);

    const sizes = Array.from(sizesList.querySelectorAll('.row-line')).map(r => {
      const [l, pr] = r.querySelectorAll('input'); const label = l.value.trim(); const price = Number(pr.value || 0);
      return label ? { label, price } : null;
    }).filter(Boolean);

    const flavours = Array.from(flavoursList.querySelectorAll('.row-line')).map(r => {
      const [l] = r.querySelectorAll('input'); const label = l.value.trim();
      return label ? { label } : null;
    }).filter(Boolean);

    const toppings = Array.from(toppingsList.querySelectorAll('.row-line')).map(r => {
      const [l, pr] = r.querySelectorAll('input'); const label = l.value.trim(); const price = Number(pr.value || 0);
      return label ? { label, price } : null;
    }).filter(Boolean);

    const data = { name, basePrice, category, image: image || '', sizes, flavours, toppings, visible, updatedAt: Date.now() };
    if (editingKey) { await db.ref(`products/${editingKey}`).update(data); }
    else { data.createdAt = Date.now(); await db.ref('products').push(data); }
    clearForm();
  } catch (e) {
    alert(e.message);
  }
};

// Initial lockdown (no flash)
lockDownUI();
</script>
</body>
</html>
