<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ã‰claÃ¯r â€” Menu</title>
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>
  <script src="script.js" defer></script>

  <style>
    /* Minimal extras; your style.css keeps the look */
    .chips { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:10px 0 20px; }
    .chip { display:inline-block; padding:8px 14px; border-radius:999px; background:#fbe1e9; color:#c94f66; font-weight:700; cursor:pointer; text-decoration:none; }
    .chip.active { background:#f78da7; color:#fff; }
    .category-block { margin: 28px auto 40px; max-width: 1100px; }
    .category-block h2 { text-align:center; color:#c94f66; margin-bottom:12px; }
    .category-block .products-grid { margin-top: 10px; }
    /* Cart & modal (lightweight) */
    #cart { position:fixed; right:20px; top:20px; background:#fff; border-radius:15px; padding:15px; width:340px; max-height:90vh; overflow:auto; box-shadow:0 4px 18px rgba(0,0,0,.15); display:none; z-index:999; }
    .cart-item { display:flex; justify-content:space-between; gap:8px; margin-bottom:8px; align-items:center; }
    .btn { display:inline-block; padding:10px 18px; background:#f78da7; color:#fff; border-radius:25px; text-decoration:none; cursor:pointer; font-weight:600; }
    .btn.small { padding:6px 12px; border-radius:14px; }
    .btn.icon { width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px; padding:0; }
    .qty { display:inline-flex; align-items:center; gap:8px; }
    .muted { color:#777; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:998; }
    .modal { background:#fff; width:min(720px, 92vw); border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.2); overflow:hidden; }
    .modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#fff3f6; }
    .modal .content { padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .modal img { width:100%; height:220px; object-fit:cover; border-radius:12px; }
    .choice { margin-bottom:10px; }
    .choice h4 { margin:8px 0; }
    .toppings { display:grid; gap:6px; max-height:160px; overflow:auto; padding-right:6px; }
    .flex { display:flex; align-items:center; gap:10px; }
    .right { text-align:right; }
    @media (max-width:720px){
      .modal .content { grid-template-columns: 1fr; }
      .modal img { height:200px; }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo"><a href="index.html">Ã‰claÃ¯r</a></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a class="active" href="menu.html">Menu</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
  </header>

  <main style="padding: 30px 20px;">
    <h1 style="text-align:center;">Our Full Menu</h1>
    <p style="text-align:center;">Updated live by the Admin</p>

    <!-- Dynamic category chips -->
    <div id="chips" class="chips"></div>

    <!-- All categories rendered below -->
    <div id="sections"></div>

    <div style="text-align:center; margin-top:16px;">
      <button class="btn" onclick="toggleCart()">ðŸ›’ View Cart (<span id="cart-count">0</span>)</button>
    </div>
  </main>

  <!-- Cart -->
  <div id="cart">
    <h3>Your Cart</h3>
    <div id="cart-items"></div>
    <hr>
    <p><b>Total: Rs <span id="cart-total">0</span></b></p>

    <div id="customer-info">
      <input type="text" id="customer-name" placeholder="Your Name" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:6px;">
      <input type="text" id="customer-phone" placeholder="Phone (starts with 5, 8 digits)" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:6px;">
    </div>

    <label>
      Payment Method:
      <select id="payment-method">
        <option value="Pay at Pickup">Pay at Pickup</option>
      </select>
    </label>

    <div style="margin-top:10px;">
      <button class="btn" onclick="checkout()">Checkout</button>
      <button class="btn" onclick="toggleCart()">Close</button>
    </div>
  </div>

  <!-- Customize Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <div class="flex">
          <strong id="modName">Item</strong>
          <span class="muted" id="modCategory"></span>
        </div>
        <button class="btn small" type="button" onclick="closeModal()">Close</button>
      </header>
      <div class="content">
        <div><img id="modImage" src="" alt=""></div>
        <div>
          <div class="choice" id="sizeChoice" style="display:none;">
            <h4>Size</h4>
            <select id="modSize"></select>
          </div>

          <div class="choice" id="flavourChoice" style="display:none;">
            <h4>Flavour</h4>
            <select id="modFlavour"></select>
          </div>

          <div class="choice" id="toppingsChoice" style="display:none;">
            <h4>Toppings</h4>
            <div class="toppings" id="modToppings"></div>
          </div>

          <div class="choice">
            <h4>Quantity</h4>
            <div class="qty">
              <button class="btn icon" type="button" onclick="changeQty(-1)">âˆ’</button>
              <strong id="modQty">1</strong>
              <button class="btn icon" type="button" onclick="changeQty(1)">+</button>
            </div>
          </div>

          <div class="right">
            <div class="muted">Item total</div>
            <h3>Rs <span id="modTotal">0</span></h3>
          </div>

          <div class="right" style="margin-top:8px;">
            <button class="btn" type="button" onclick="confirmAdd()">Add to Cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat (order matters) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase init (RTDB)
    (function initFirebase(){
      const firebaseConfig = {
        apiKey: "AIzaSyDnYlw01KhjWRXLhatnr9fFcXA4Q_zOs10",
        authDomain: "eclair-501b7.firebaseapp.com",
        databaseURL: "https://eclair-501b7-default-rtdb.firebaseio.com",
        projectId: "eclair-501b7",
        storageBucket: "eclair-501b7.appspot.com",
        messagingSenderId: "1042027942352",
        appId: "1:1042027942352:web:fa760d5609f5713c0d69d5",
        measurementId: "G-BC1Z5MKSTH"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      window.__DB__ = firebase.database();
    })();

    // ---------- Utilities ----------
    const PREFERRED_ORDER = [
      "Pastries","Cakes","Drinks","Sparkling","Iced Tea","Tea","Coffee","Iced Coffee"
    ];
    const slug = s => String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function sortCategories(keys){
      return keys.slice().sort((a,b) => {
        const ia = PREFERRED_ORDER.indexOf(a);
        const ib = PREFERRED_ORDER.indexOf(b);
        if (ia !== -1 || ib !== -1) {
          return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
        }
        return a.localeCompare(b);
      });
    }

    // ---------- Render ALL categories as blocks ----------
    const chips = document.getElementById('chips');
    const sections = document.getElementById('sections');
    let PRODUCTS = {}; // id -> product
    let GROUPS = {};   // category -> [products]

    function renderChips(catKeys, activeCat){
      chips.innerHTML = [
        `<a class="chip ${!activeCat ? 'active':''}" href="menu.html#top">All</a>`,
        ...catKeys.map(k => `<a class="chip ${activeCat===k?'active':''}" href="#cat-${slug(k)}">${k}</a>`)
      ].join('');
    }

    function cardHTML(p){
      const fromPrice = (p.sizes && p.sizes.length)
        ? Math.min(...p.sizes.map(s => Number(s.price||0)))
        : Number(p.basePrice||0);
      return `
        <div class="product-card">
          <img src="${p.image||''}" alt="${p.name||''}">
          <h4>${p.name||''}</h4>
          <p class="price">From Rs ${fromPrice}</p>
          <button class="btn" onclick='openModal(${JSON.stringify(p._id)})'>Customize</button>
        </div>
      `;
    }

    function renderSections(filterCat=null){
      const keys = Object.keys(GROUPS);
      const showKeys = filterCat ? keys.filter(k => k===filterCat) : keys;
      sections.innerHTML = showKeys.map(cat => `
        <section class="category-block" id="cat-${slug(cat)}">
          <h2>${cat}</h2>
          <div class="products-grid">
            ${GROUPS[cat].map(cardHTML).join('')}
          </div>
        </section>
      `).join('');
    }

    function loadAll(){
      const urlCat = new URLSearchParams(location.search).get('cat');
      window.__DB__.ref('products').on('value', snap => {
        const obj = snap.val() || {};
        const all = Object.entries(obj)
          .map(([id,p]) => ({...p, _id:id}))
          .filter(p => p.visible);

        // Group by category
        const groups = {};
        for (const p of all) {
          const cat = p.category || 'Other';
          (groups[cat] ||= []).push(p);
        }
        // Sort each group newest first
        for (const k in groups) {
          groups[k].sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
        }
        // Sort categories (preferred order first, then alphabetic)
        const catKeys = sortCategories(Object.keys(groups));

        // Keep globals
        PRODUCTS = Object.fromEntries(all.map(p => [p._id, p]));
        GROUPS = Object.fromEntries(catKeys.map(k => [k, groups[k]]));

        renderChips(catKeys, urlCat);
        renderSections(urlCat || null);
      });
    }

    // ---------- Modal / Customize (sizes, flavours, toppings, qty) ----------
    const backdrop = document.getElementById('modalBackdrop');
    const modName = document.getElementById('modName');
    const modCategory = document.getElementById('modCategory');
    const modImage = document.getElementById('modImage');
    const modSize = document.getElementById('modSize');
    const sizeChoice = document.getElementById('sizeChoice');
    const modFlavour = document.getElementById('modFlavour');
    const flavourChoice = document.getElementById('flavourChoice');
    const modToppings = document.getElementById('modToppings');
    const toppingsChoice = document.getElementById('toppingsChoice');
    const modQty = document.getElementById('modQty');
    const modTotal = document.getElementById('modTotal');

    let CURRENT = null;
    function openModal(id){
      const p = PRODUCTS[id];
      if (!p) return;
      CURRENT = {
        id, name:p.name, category:p.category, image:p.image,
        basePrice: Number(p.basePrice||0),
        sizes: p.sizes||[],
        flavours: p.flavours||[],
        toppings: p.toppings||[],
        qty: 1,
        sizeIndex: (p.sizes && p.sizes.length) ? 0 : -1,
        flavourIndex: (p.flavours && p.flavours.length) ? 0 : -1,
        toppingSet: new Set()
      };

      modName.textContent = p.name||'';
      modCategory.textContent = p.category||'';
      modImage.src = p.image||'';

      // Sizes
      if (CURRENT.sizes.length){
        sizeChoice.style.display = '';
        modSize.innerHTML = CURRENT.sizes.map((s,i)=>`<option value="${i}">${s.label} â€” Rs ${Number(s.price||0)}</option>`).join('');
        modSize.value = String(CURRENT.sizeIndex);
      } else { sizeChoice.style.display = 'none'; }

      // Flavours
      if (CURRENT.flavours.length){
        flavourChoice.style.display = '';
        modFlavour.innerHTML = CURRENT.flavours.map((f,i)=>`<option value="${i}">${f.label}</option>`).join('');
        modFlavour.value = String(CURRENT.flavourIndex);
      } else { flavourChoice.style.display = 'none'; }

      // Toppings
      if (CURRENT.toppings.length){
        toppingsChoice.style.display = '';
        modToppings.innerHTML = CURRENT.toppings.map((t, i) => `
          <label class="flex">
            <input type="checkbox" data-top="${i}">
            <span>${t.label} <span class="muted">(Rs ${Number(t.price||0)})</span></span>
          </label>
        `).join('');
      } else { toppingsChoice.style.display = 'none'; }

      modQty.textContent = '1';
      recalc();
      backdrop.style.display = 'flex';
    }
    function closeModal(){ backdrop.style.display = 'none'; CURRENT = null; }

    modSize.addEventListener('change', () => { CURRENT.sizeIndex = Number(modSize.value||0); recalc(); });
    modFlavour.addEventListener('change', () => { CURRENT.flavourIndex = Number(modFlavour.value||0); });
    modToppings.addEventListener('change', (e) => {
      if (!e.target || !e.target.dataset.top) return;
      const idx = Number(e.target.dataset.top);
      if (e.target.checked) CURRENT.toppingSet.add(idx);
      else CURRENT.toppingSet.delete(idx);
      recalc();
    });

    function changeQty(delta){
      if (!CURRENT) return;
      CURRENT.qty = Math.max(1, CURRENT.qty + delta);
      modQty.textContent = String(CURRENT.qty);
      recalc();
    }
    function recalc(){
      if (!CURRENT) return;
      let unit = CURRENT.sizes.length
        ? Number(CURRENT.sizes[CURRENT.sizeIndex]?.price || 0)
        : Number(CURRENT.basePrice || 0);
      let tops = 0;
      CURRENT.toppingSet.forEach(i => tops += Number(CURRENT.toppings[i]?.price || 0));
      const total = (unit + tops) * CURRENT.qty;
      modTotal.textContent = total;
    }

    // ---------- Cart ----------
    let CART = [];
    function addToCartLine(line){ CART.push(line); renderCart(); }
    function renderCart(){
      const itemsDiv = document.getElementById('cart-items');
      const totalEl = document.getElementById('cart-total');
      const badge = document.getElementById('cart-count');
      let total = 0;
      itemsDiv.innerHTML = CART.map((it, idx) => {
        const tops = it.toppings?.length ? ` + ${it.toppings.map(t=>t.label).join(', ')}` : '';
        const opts = `${it.size ? ` (${it.size})` : ''}${it.flavour ? ` - ${it.flavour}` : ''}${tops}`;
        const line = it.unitPrice * it.qty;
        total += line;
        return `
          <div class="cart-item">
            <div style="text-align:left;">
              <div><b>${it.name}</b>${opts}</div>
              <div class="muted">Rs ${it.unitPrice} Ã— ${it.qty} = <b>Rs ${line}</b></div>
            </div>
            <div class="qty">
              <button class="btn icon" onclick="decQty(${idx})">âˆ’</button>
              <span>${it.qty}</span>
              <button class="btn icon" onclick="incQty(${idx})">+</button>
              <button class="btn icon" onclick="removeLine(${idx})">âœ•</button>
            </div>
          </div>
        `;
      }).join('');
      totalEl.textContent = total;
      badge.textContent = CART.reduce((a,b)=>a+b.qty,0);
    }
    function incQty(i){ CART[i].qty++; renderCart(); }
    function decQty(i){ CART[i].qty = Math.max(1, CART[i].qty-1); renderCart(); }
    function removeLine(i){ CART.splice(i,1); renderCart(); }
    function toggleCart(){
      const cartDiv = document.getElementById('cart');
      cartDiv.style.display = cartDiv.style.display==='block' ? 'none' : 'block';
      renderCart();
    }

    function confirmAdd(){
      if (!CURRENT) return;
      const sizeObj = CURRENT.sizes.length ? CURRENT.sizes[CURRENT.sizeIndex] : null;
      const unit = sizeObj ? Number(sizeObj.price||0) : Number(CURRENT.basePrice||0);
      let tops = [];
      CURRENT.toppingSet.forEach(i => { const t = CURRENT.toppings[i]; if (t) tops.push({label:t.label, price:Number(t.price||0)}) });
      const unitPlusTops = unit + tops.reduce((s,t)=>s+(t.price||0),0);

      const line = {
        productId: CURRENT.id,
        name: CURRENT.name,
        size: sizeObj ? sizeObj.label : null,
        flavour: CURRENT.flavours.length && CURRENT.flavourIndex>=0 ? CURRENT.flavours[CURRENT.flavourIndex].label : null,
        toppings: tops,
        unitPrice: unitPlusTops,
        qty: CURRENT.qty
      };
      addToCartLine(line);
      closeModal();
      toggleCart();
    }

    // ---------- Checkout (push order to RTDB /orders) ----------
    async function checkout(){
      if (!CART.length) return alert('Cart is empty!');
      const name = (document.getElementById('customer-name')||{}).value?.trim();
      const phone = (document.getElementById('customer-phone')||{}).value?.trim();
      const method = (document.getElementById('payment-method')||{}).value || 'Pay at Pickup';
      const phoneRegex = /^5\d{7}$/; // Mauritius mobile
      if (!name || !phoneRegex.test(phone||'')) return alert('Enter a name and a valid phone (starts with 5, 8 digits).');
      const total = CART.reduce((s,it)=> s + it.unitPrice*it.qty, 0);

      const order = {
        customer: { name, phone },
        items: CART,
        paymentMethod: method,
        total,
        createdAt: Date.now()
      };

      try {
        await window.__DB__.ref('orders').push(order);
        alert('Order placed successfully!');
        CART = []; renderCart(); toggleCart();
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-phone').value = '';
      } catch(e){ alert(e.message); }
    }

    // expose for buttons
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.changeQty = changeQty;
    window.confirmAdd = confirmAdd;
    window.toggleCart = toggleCart;
    window.checkout = checkout;
    window.incQty = incQty;
    window.decQty = decQty;
    window.removeLine = removeLine;

    document.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
